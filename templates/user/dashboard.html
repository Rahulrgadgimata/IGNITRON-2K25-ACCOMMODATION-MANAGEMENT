{% extends "base.html" %}

{% block title %}User Dashboard - Ignitron Accommodation{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4"><i class="bi bi-speedometer2"></i> Welcome, {{ user.name }}!</h1>

    <!-- Active Booking Status -->
    {% if active_booking %}
    <div class="alert alert-{{ 'success' if active_booking.status == 'checked_in' else 'info' if active_booking.status == 'approved' else 'warning' }} mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-1">
                    <i class="bi bi-{{ 'check-circle' if active_booking.status == 'checked_in' else 'clock' if active_booking.status == 'approved' else 'hourglass-split' }}"></i>
                    Current Booking Status
                </h5>
                <p class="mb-0">
                    <strong>Room:</strong> {{ active_booking.room.room_no }} | 
                    <strong>Status:</strong> 
                    <span class="badge bg-{{ 'success' if active_booking.status == 'checked_in' else 'info' if active_booking.status == 'approved' else 'warning' }}">
                        {{ active_booking.status.replace('_', ' ').title() }}
                    </span>
                    {% if active_booking.checkin_time %}
                    | <strong>Checked in:</strong> {{ active_booking.checkin_time.strftime('%Y-%m-%d %H:%M') }}
                    {% endif %}
                </p>
            </div>
            <div>
                {% if active_booking.status == 'approved' %}
                <form method="POST" action="{{ url_for('user.checkin', booking_id=active_booking.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-box-arrow-in-right"></i> Check In
                    </button>
                </form>
                {% elif active_booking.status == 'checked_in' %}
                <form method="POST" action="{{ url_for('user.checkout', booking_id=active_booking.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-warning" onclick="return confirm('Are you sure you want to check out?');">
                        <i class="bi bi-box-arrow-right"></i> Check Out
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Available Rooms -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-door-open"></i> Available Rooms</h5>
                </div>
                <div class="card-body">
                    {% if available_rooms %}
                    <div class="row g-3">
                        {% for room in available_rooms %}
                        {% set occupied = room.get_occupied_beds() %}
                        {% set occupancy_percent = (occupied / room.capacity * 100) if room.capacity > 0 else 0 %}
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="bi bi-door-open"></i> Room {{ room.room_no }}
                                    </h5>
                                    <p class="card-text">
                                        <strong>Capacity:</strong> {{ room.capacity }} beds<br>
                                        <strong>Occupied:</strong> 
                                        <span class="badge bg-info">{{ occupied }} beds</span><br>
                                        <strong>Available:</strong> 
                                        <span class="badge bg-{{ 'success' if room.available_beds > 0 else 'danger' }}">
                                            {{ room.available_beds }} beds
                                        </span>
                                    </p>
                                    <div class="mb-2">
                                        <small class="text-muted">Occupancy: </small>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-{{ 'success' if occupancy_percent < 50 else 'warning' if occupancy_percent < 80 else 'danger' }}" 
                                                 role="progressbar" 
                                                 style="width: {{ occupancy_percent }}%"
                                                 aria-valuenow="{{ occupancy_percent }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                {{ occupancy_percent|round|int }}%
                                            </div>
                                        </div>
                                    </div>
                                    {% if room.description %}
                                    <p class="card-text text-muted"><small>{{ room.description }}</small></p>
                                    {% endif %}
                                    {% if not active_booking %}
                                    <form method="POST" action="{{ url_for('user.request_booking') }}">
                                        <input type="hidden" name="room_id" value="{{ room.id }}">
                                        <button type="submit" class="btn btn-primary btn-sm" {{ 'disabled' if room.available_beds <= 0 else '' }}>
                                            <i class="bi bi-calendar-plus"></i> Request Booking
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center">No rooms available at the moment.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- My Bookings -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-calendar-check"></i> My Bookings</h5>
                </div>
                <div class="card-body">
                    {% if bookings %}
                    <div class="list-group list-group-flush">
                        {% for booking in bookings %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Room {{ booking.room.room_no }}</h6>
                                <span class="badge bg-{{ 'warning' if booking.status == 'pending' else 'success' if booking.status == 'approved' else 'primary' if booking.status == 'checked_in' else 'danger' if booking.status == 'rejected' else 'secondary' }}">
                                    {{ booking.status.replace('_', ' ').title() }}
                                </span>
                            </div>
                            <small class="text-muted">{{ booking.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center">No bookings yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

